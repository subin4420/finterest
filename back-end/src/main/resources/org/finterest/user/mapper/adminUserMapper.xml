<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.finterest.user.mapper.AdminUserMapper">
    <!-- 사용자 목록 조회 -->
    <select id="selectAllUsers" resultType="org.finterest.user.vo.UserVO">
        SELECT
        u.user_id AS userId,
        u.username AS username,
        u.email AS email,
        u.full_name AS fullName,
        u.account_status AS accountStatus,
        u.signup_date AS signupDate,
        u.last_login AS lastLogin,
        u.total_points AS totalPoints,
        r.rank_position AS rankPosition,
        r.rank_title AS rankTitle,
        GROUP_CONCAT(ua.auth) AS roles  -- 권한을 문자열로 집계
        FROM Users u
        LEFT JOIN user_ranking r ON u.user_id = r.user_id
        LEFT JOIN Users_auth ua ON u.username = ua.username
        WHERE 1=1
        <if test="status != null">
            AND u.account_status = #{status}
        </if>
        GROUP BY u.user_id, u.username, u.email, u.full_name, u.account_status, u.signup_date, u.last_login, u.total_points, r.rank_position, r.rank_title
        <if test="sortBy != null">
            ORDER BY ${sortBy} ${order}
        </if>
        <if test="sortBy == null">
            ORDER BY u.signup_date DESC
        </if>
    </select>

    <!-- 특정 사용자의 계정 상태 업데이트 -->
    <update id="updateUserStatus" parameterType="map">
        UPDATE Users
        SET account_status = #{accountStatus}
        WHERE user_id = #{userId}
    </update>

    <!-- 특정 사용자 삭제 -->
    <delete id="deleteUser" parameterType="int">
        DELETE FROM Users
        WHERE user_id = #{userId}
    </delete>

</mapper>
